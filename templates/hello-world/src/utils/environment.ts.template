import fs from "fs";
import path from "path";
import { NetworkId, setNetworkId } from "@midnight-ntwrk/midnight-js-network-id";
import { NetworkConfig } from "../providers/midnight-providers.js";

const SUPPORTED_NETWORKS = ["preprod"] as const;
type SupportedNetwork = (typeof SUPPORTED_NETWORKS)[number];

export class EnvironmentManager {
  private static networkConfig: NetworkConfig | null = null;

  static getNetworkConfig(): NetworkConfig {
    if (this.networkConfig) return this.networkConfig;

    const network = process.env.MIDNIGHT_NETWORK || "preprod";

    if (!SUPPORTED_NETWORKS.includes(network as SupportedNetwork)) {
      console.warn(
        `Warning: Unknown network "${network}", falling back to "preprod". ` +
        `Supported networks: ${SUPPORTED_NETWORKS.join(", ")}`
      );
    }

    const networks: Record<SupportedNetwork, NetworkConfig> = {
      preprod: {
        indexer: "https://indexer.preprod.midnight.network/api/v3/graphql",
        indexerWS: "wss://indexer.preprod.midnight.network/api/v3/graphql/ws",
        node: "https://rpc.preprod.midnight.network",
        proofServer: process.env.PROOF_SERVER_URL || "http://127.0.0.1:6300",
        name: "Preprod",
        faucetUrl: "https://faucet.preprod.midnight.network/",
        networkId: NetworkId.TestNet,
      },
    };

    this.networkConfig = networks[network as SupportedNetwork] || networks.preprod;
    return this.networkConfig;
  }

  static initializeNetwork(): NetworkConfig {
    const config = this.getNetworkConfig();
    setNetworkId(config.networkId);
    return config;
  }

  static validateEnvironment(): void {
    const required = ["WALLET_SEED"];
    const missing = required.filter((key) => !process.env[key]);

    if (missing.length > 0) {
      throw new Error(
        `Missing required environment variables: ${missing.join(", ")}`
      );
    }

    const walletSeed = process.env.WALLET_SEED!;
    if (!/^[a-fA-F0-9]{64}$/.test(walletSeed)) {
      throw new Error("WALLET_SEED must be a 64-character hexadecimal string");
    }
  }

  static checkContractCompiled(contractName: string): boolean {
    const contractPath = path.join(
      process.cwd(),
      "contracts",
      "managed",
      contractName
    );
    const keysPath = path.join(contractPath, "keys");
    // Check for both .js (ESM) and .cjs (CommonJS) outputs
    const contractModuleJs = path.join(contractPath, "contract", "index.js");
    const contractModuleCjs = path.join(contractPath, "contract", "index.cjs");

    return fs.existsSync(keysPath) && (fs.existsSync(contractModuleJs) || fs.existsSync(contractModuleCjs));
  }
}
